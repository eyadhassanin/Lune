<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LUNE Admin – Reservations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #d4af37;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #111;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }
        th {
            background: #222;
        }
        input[type="text"], input[type="number"] {
            width: 95%;
            padding: 4px;
            background: #222;
            border: 1px solid #444;
            color: #fff;
        }
        button {
            padding: 6px 10px;
            margin: 2px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }
        .btn-save {
            background: #28a745;
            color: #fff;
        }
        .btn-delete {
            background: #dc3545;
            color: #fff;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-bar a {
            color: #d4af37;
            text-decoration: none;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="top-bar">
    <h1>Reservations – Admin</h1>
    <div>
        <span id="adminEmail"></span>
        <a href="#" id="logoutLink">Logout</a>
    </div>
</div>

<table id="reservationsTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Table #</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <!-- rows inserted by JS -->
    </tbody>
</table>

<script>
    // Basic admin check
    const stored = localStorage.getItem("luneUser");
    if (!stored) {
        alert("Please sign in as admin.");
        window.location.href = "/signin.html";
    } else {
        const user = JSON.parse(stored);
        if (user.role !== "ADMIN") {
            alert("Access denied. Admin only.");
            window.location.href = "/index.html";
        } else {
            document.getElementById("adminEmail").textContent = user.email;
        }
    }

    document.getElementById("logoutLink").addEventListener("click", function (e) {
        e.preventDefault();
        localStorage.removeItem("luneUser");
        window.location.href = "/signin.html";
    });

    const tbody = document.querySelector("#reservationsTable tbody");

    async function loadReservations() {
        tbody.innerHTML = "";
        try {
            const res = await fetch("/api/reserve");
            if (!res.ok) {
                alert("Failed to load reservations.");
                return;
            }
            const data = await res.json(); // list of reservations
            data.forEach(addRow);
        } catch (err) {
            console.error(err);
            alert("Error loading reservations.");
        }
    }

    function addRow(r) {
        const tr = document.createElement("tr");
        tr.dataset.id = r.id;

        const idTd = document.createElement("td");
        idTd.textContent = r.id;

        const nameTd = document.createElement("td");
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = r.name || "";
        nameTd.appendChild(nameInput);

        const phoneTd = document.createElement("td");
        const phoneInput = document.createElement("input");
        phoneInput.type = "text";
        phoneInput.value = r.phone || "";
        phoneTd.appendChild(phoneInput);

        const tableTd = document.createElement("td");
        const tableInput = document.createElement("input");
        tableInput.type = "number";
        tableInput.value = r.tableNumber;
        tableTd.appendChild(tableInput);

        const actionsTd = document.createElement("td");
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Save";
        saveBtn.className = "btn-save";
        saveBtn.addEventListener("click", async () => {
            await saveReservation(tr.dataset.id, nameInput.value, phoneInput.value, tableInput.value);
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "btn-delete";
        delBtn.addEventListener("click", async () => {
            await deleteReservation(tr.dataset.id, tr);
        });

        actionsTd.appendChild(saveBtn);
        actionsTd.appendChild(delBtn);

        tr.appendChild(idTd);
        tr.appendChild(nameTd);
        tr.appendChild(phoneTd);
        tr.appendChild(tableTd);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
    }

    async function saveReservation(id, name, phone, tableNumber) {
        try {
            const res = await fetch(`/api/reserve/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: name,
                    phone: phone,
                    tableNumber: parseInt(tableNumber, 10)
                })
            });
            if (!res.ok) {
                const msg = await res.text();
                alert("Failed to save: " + msg);
            } else {
                alert("Reservation updated.");
            }
        } catch (err) {
            console.error(err);
            alert("Error saving reservation.");
        }
    }

    async function deleteReservation(id, rowEl) {
        if (!confirm("Delete this reservation?")) return;
        try {
            const res = await fetch(`/api/reserve/${id}`, { method: "DELETE" });
            if (res.status === 204) {
                rowEl.remove();
            } else if (!res.ok) {
                const msg = await res.text();
                alert("Failed to delete: " + msg);
            }
        } catch (err) {
            console.error(err);
            alert("Error deleting reservation.");
        }
    }

    loadReservations();
</script>
</body>
</html>
